{% extends "base.html" %}

{% block content %}
    <div class="homepage-container">
        <div class="homepage-left">
            <section class="recent-notifications">
                <h2>Recent Notifications</h2>
                {% if notification_logs %}
                    <div class="notification-entries">
                        {% for notification in notification_logs %}
                            <div class="notification-entry">
                                <div class="notification-header">
                                    <span class="notification-time">{{ notification.timestamp|datetimeformat('%b %d, %H:%M:%S') }}</span>
                                    <span class="notification-flow">{{ notification.flow_name }}</span>
                                    {% if notification.webhook_name %}
                                        <span class="notification-webhook">via {{ notification.webhook_name }}</span>
                                    {% endif %}
                                </div>
                                {% if notification.message_content %}
                                    <div class="notification-message">
                                        <strong>Message:</strong> {{ notification.message_content }}
                                    </div>
                                {% endif %}
                                {% if notification.embed_info %}
                                    <div class="notification-embed">
                                        <strong>Embed:</strong> 
                                        {% if notification.embed_info.title %}
                                            <span class="embed-title">{{ notification.embed_info.title }}</span>
                                        {% endif %}
                                        {% if notification.embed_info.description %}
                                            <span class="embed-description">{{ notification.embed_info.description }}</span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>No notifications sent yet.</p>
                {% endif %}
            </section>

            <section class="test-notification">
                <h2>Send Test Notification</h2>
                <form method="post" id="test-form">
                    <input type="text" name="test_message" placeholder="Test message" required>
                    <button type="submit" id="test-submit">
                        <span class="button-text">Send to Discord</span>
                        <div class="button-spinner" style="display: none;"></div>
                    </button>
                </form>
            </section>
        </div>

        <div class="homepage-right">
            <section class="active-flows">
                <div class="flows-header">
                    <h2>Active Notification Flows ({{ active_flows|length }})</h2>
                </div>
                
                <!-- Category Filter -->
                <div class="category-filter">
                    <label for="homepage-category-filter">Filter by Category:</label>
                    <select id="homepage-category-filter">
                        <option value="">All Categories</option>
                        <option value="General">General</option>
                        <option value="Media">Media</option>
                        <option value="System">System</option>
                        <option value="Monitoring">Monitoring</option>
                        <option value="Reports">Reports</option>
                        <option value="Alerts">Alerts</option>
                    </select>
                </div>
                
                {% if active_flows %}
                    <div class="flow-grid">
                        {% for flow in active_flows %}
                            <div class="flow-card" data-category="{{ flow.category or 'General' }}">
                                <div class="flow-header">
                                    <h3>{{ flow.name }}</h3>
                                    <div class="flow-actions">
                                        <a href="{{ url_for('notification_builder') }}?edit={{ flow.name }}" 
                                           class="btn-edit-flow" title="Edit Flow">
                                            Edit
                                        </a>
                                        <button class="btn-toggle-flow" 
                                                onclick="toggleFlow('{{ flow.name }}', false)" 
                                                title="Disable Flow">
                                            Disable
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flow-meta">
                                    <div class="flow-meta-item">
                                        <span class="flow-meta-label">Category</span>
                                        <span class="flow-meta-value">{{ flow.category or 'General' }}</span>
                                    </div>
                                    <div class="flow-meta-item">
                                        <span class="flow-meta-label">Type</span>
                                        <span class="flow-meta-value">
                                            {% if flow.trigger_type == 'timer' %}
                                                <span class="flow-type timer">Scheduled ({{ flow.interval }}m)</span>
                                            {% elif flow.trigger_type == 'on_change' %}
                                                <span class="flow-type change">Change Detection</span>
                                            {% elif flow.trigger_type == 'on_incoming' %}
                                                <span class="flow-type webhook">Webhook</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="flow-status">
                                    {% if flow.trigger_type == 'on_change' and 'last_value' in flow %}
                                        <div class="status-indicator monitoring"></div>
                                        <span class="status-text">Monitoring (Current: {{ flow.last_value }})</span>
                                    {% elif flow.trigger_type == 'timer' and 'last_run' in flow %}
                                        <div class="status-indicator active"></div>
                                        <span class="status-text">Last ran: {{ flow.last_run|datetimeformat }}</span>
                                    {% else %}
                                        <div class="status-indicator active"></div>
                                        <span class="status-text">Active</span>
                                    {% endif %}
                                </div>
                                
                                {% if flow.trigger_type == 'on_incoming' %}
                                    <div class="flow-webhook-url">/api/webhook/{{ flow.name }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>No active notification flows configured.</p>
                {% endif %}
            </section>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Category filter functionality for homepage
            const categoryFilter = document.getElementById('homepage-category-filter');
            if (categoryFilter) {
                categoryFilter.addEventListener('change', function() {
                    const selectedCategory = this.value;
                    const flowCards = document.querySelectorAll('.flow-card');
                    let visibleCount = 0;
                    
                    flowCards.forEach(card => {
                        const cardCategory = card.dataset.category;
                        if (!selectedCategory || cardCategory === selectedCategory) {
                            card.style.display = 'block';
                            visibleCount++;
                        } else {
                            card.style.display = 'none';
                        }
                    });
                    
                    // Update the flows count in the header
                    const flowsHeader = document.querySelector('.flows-header h2');
                    if (flowsHeader) {
                        const totalFlows = document.querySelectorAll('.flow-card').length;
                        flowsHeader.textContent = `Active Notification Flows (${visibleCount}/${totalFlows})`;
                    }
                });
            }
            
            // Test form loading state
            const testForm = document.getElementById('test-form');
            if (testForm) {
                testForm.addEventListener('submit', function() {
                    const submitButton = document.getElementById('test-submit');
                    const buttonText = submitButton.querySelector('.button-text');
                    const buttonSpinner = submitButton.querySelector('.button-spinner');
                    
                    submitButton.disabled = true;
                    buttonText.style.display = 'none';
                    buttonSpinner.style.display = 'inline-block';
                    submitButton.classList.add('loading');
                });
            }
        });
        
        function toggleFlow(flowName, active) {
            const button = event.target;
            const originalText = button.textContent;
            const flowCard = button.closest('.flow-card');
            
            // Add loading state
            button.disabled = true;
            button.textContent = 'Loading...';
            button.classList.add('loading');
            flowCard.classList.add('flow-card-loading');
            
            fetch('/toggle_flow', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    flow_name: flowName,
                    active: active
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`Flow "${flowName}" ${active ? 'enabled' : 'disabled'} successfully`, 'success');
                    // Reload the page after a short delay to show the toast
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast(`Failed to toggle flow: ${error.message}`, 'error');
                
                // Reset button state on error
                button.disabled = false;
                button.textContent = originalText;
                button.classList.remove('loading');
                flowCard.classList.remove('flow-card-loading');
            });
        }
    </script>
{% endblock %}